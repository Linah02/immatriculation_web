{% load static %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}Page d'Accueil{% endblock %}</title>
        <link rel="stylesheet" href="{% static 'myapp/css/acceuils_style.css' %}">
        <link rel="stylesheet" href="{% static 'myapp/css/home_style.css' %}">
        <link rel="stylesheet" href="{% static 'myapp/css/personnel_form.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
    <style>
        body{
    background-image: url("{% static 'myapp/images/Login/Capture d’écran 2024-11-29 131202.png' %}");
    background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
}
    </style>    
    </head>
        
<body>
    
    
    <header>
        {% include 'layout/sidebar_acc.html' %}
        
    </header>
    <style>
       
    
    
    </style>
    <div class="page-container">
        <h3>Formulaire Partie 2 - Données soumises :</h3>
<p><strong>CIN :</strong> {{ request.POST.cin }}</p>
<p><strong>Contact :</strong> {{ request.POST.contact }}</p>
<p><strong>Lieu de délivrance :</strong> {{ request.POST.lieu_delivrance }}</p>
<p><strong>Date de délivrance :</strong> {{ request.POST.date_delivrance }}</p>
<p><strong>Fokontany :</strong> {{ request.POST.fkt_no }}</p>
<p><strong>Email :</strong> {{ request.POST.email }}</p>
{% if operateurs and operateurs|length > 0 %}
    <h3>Liste des opérateurs correspondants:</h3>
    <ul>
        {% for operateur in operateurs %}
            <li>CIN: {{ operateur.cin }} | Contact: {{ operateur.contact }}</li>
        {% endfor %}
    </ul>
{% else %}
    <p>Aucun opérateur correspondant trouvé.</p>
{% endif %}

        <!-- Sidebar et contenu principal côte à côte -->
        <div class="content-wrapper">
            <main class="main-content">
<div class="container">
    <h2 style="margin-bottom: 1px;">Résidence et CIN</h2>
    <p style="color: rgb(99, 141, 161); margin-top: 1px;">Les champs marqués en <class  style="color: red;">***</class> sont obligatoires</p>

    <form method="post" action="{% url 'form_part2' %}">
        {% csrf_token %}
        <div class="container_card">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Province</label>
                        <input type="text" id="province-input" class="form-control" placeholder="Rechercher une province..." required>
                        <div id="province-suggestions" class="suggestions"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>N° CIN <class  style="color: red;">***</class></label>
                        <input type="text" class="form-control" name="cin" maxlength="12"  placeholder="000 000 000 000"  required />
            </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Région</label>
                        <input type="text" id="region-input" class="form-control" name="parish_name" required />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Date de délivrance</label>
                        <input type="date" class="form-control" name="date_delivrance" required />
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>District</label>
                        <input type="text" id="district-input" class="form-control" name="locality_desc" required />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Lieu de délivrance</label>
                        <select class="form-control" name="lieu_delivrance" required>
                            <option value="">Choisissez...</option>
                            <option value="Antananarivo">Antananarivo</option>
                            <option value="Antsiranana">Antsiranana</option>
                            <option value="Fianarantsoa">Fianarantsoa</option>
                            <option value="Mahajanga">Mahajanga</option>
                            <option value="Toamasina">Toamasina</option>
                            <option value="Toliara">Toliara</option>
                            <option value="Ambatondrazaka">Ambatondrazaka</option>
                            <option value="Ambositra">Ambositra</option>
                            <option value="Andapa">Andapa</option>
                            <option value="Anjozorobe">Anjozorobe</option>
                            <option value="Antalaha">Antalaha</option>
                            <option value="Antsirabe">Antsirabe</option>
                            <option value="Farafangana">Farafangana</option>
                            <option value="Fenoarivo Atsinanana">Fenoarivo Atsinanana</option>
                            <option value="Ihosy">Ihosy</option>
                            <option value="Maintirano">Maintirano</option>
                            <option value="Manakara">Manakara</option>
                            <option value="Mananjary">Mananjary</option>
                            <option value="Mandritsara">Mandritsara</option>
                            <option value="Moramanga">Moramanga</option>
                            <option value="Morondava">Morondava</option>
                            <option value="Sambava">Sambava</option>
                            <option value="Taolagnaro">Taolagnaro</option>                            
                        </select>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Commune</label>
                        <input type="text" id="commune-input" class="form-control" name="wereda_desc" required />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Contact <class  style="color: red;">***</class></label>
                        <input type="text" maxlength="10" class="form-control" name="contact" required placeholder="000 00 000 00" />
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Fokontany</label>
                        <input type="text" id="fokontany-input" class="form-control" name="fokontany" required />
                    </div>
                </div>
                <input type="hidden" id="fkt-no-input" name="fkt_no" />
                <div class="col-md-6">
                    <div class="form-group">
                        <label>E-mail <class  style="color: red;">***</class></label>
                        <input type="email" class="form-control" name="email" required />
                    </div>
                </div>

            <div style="display: flex; justify-content: flex-start;">
                <a href="{% url 'home' %}">
                    <button type="button" class="btn btn-light">Précédent</button>
                </a>
                <button type="submit" class="btn btn-warning btn-icon-text" style="margin-left: 10px;">Valider</button>
            </div>
        </div>
    </form>
</div>

</main>
</div>
</div>

<footer>
    {% include 'layout/footer_acceuil.html' %}
</footer>

<script>
    document.getElementById('province-input').addEventListener('input', function() {
      console.log("Entrée détectée dans le champ province");  // Vérifier que l'événement est capté
      const query = this.value;
      console.log("Typed:", query); // Ajoute ce log pour vérifier les entrées
      
      const suggestionsBox = document.getElementById('province-suggestions');
  
      if (query.length === 0) {
          suggestionsBox.innerHTML = '';
          return;
      }
  
      fetch(`/search_province/?query=${query}`)
  .then(response => response.json())
  .then(data => {
      console.log("Données reçues:", data); // Vérifier les données
      suggestionsBox.innerHTML = '';  // Nettoyer la boîte de suggestions
      
      if (data.length === 0) {
          console.log("Aucune suggestion trouvée");
      }
  
      data.forEach(item => {
          console.log("Ajout de suggestion:", item.label); // Vérifier chaque suggestion ajoutée
          const suggestion = document.createElement('div');
          suggestion.classList.add('suggestion-item');
          suggestion.textContent = item.label;
          suggestion.onclick = function() {
              document.getElementById('province-input').value = item.city_name;
              // Assurez-vous que ces champs existent dans le DOM
              document.getElementById('region-input').value = item.parish_name || '';  
              document.getElementById('district-input').value = item.locality_desc || '';
              document.getElementById('commune-input').value = item.wereda_desc || '';
              document.getElementById('fokontany-input').value = item.fkt_desc || '';
              document.getElementById('fkt-no-input').value = item.fkt_no || '';
  
              suggestionsBox.innerHTML = '';  // Vider les suggestions une fois sélectionnées
          };
          suggestionsBox.appendChild(suggestion);
         });
  })
  .catch(error => {
      console.error('Erreur lors du fetch:', error);
      suggestionsBox.innerHTML = '<p>Impossible de charger les provinces.</p>';
  });
  });
  
  
  // Styles for suggestions
      const style = document.createElement('style');
      style.innerHTML = `
          .suggestions {
              display: block !important;
              position: relative !important;
              border: 1px solid #ccc;
              max-height: 150px;
              overflow-y: auto;
              position: absolute; /* Si nécessaire, assurez-vous que la position est correcte */
              background-color: white;
              z-index: 1000;
          }
          .suggestion-item {
              padding: 10px;
              cursor: pointer;
          }
          .suggestion-item:hover {
              background-color: #f0f0f0;
          }
      `;
      document.head.appendChild(style);
      </script>
  
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      
  </body>
  
  </html>
  
<!-- Button trigger modal (hidden, triggered via JS after successful submission) -->
<button type="button" id="successModalButton" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#successModal" style="display:none;"></button>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">Inscription réussie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="bi bi-check-circle-fill" style="font-size: 4rem; color: green;"></i>
                    <p>{{ success_message }}</p>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{% url 'connexion' %}" class="btn btn-primary">Aller à la page de connexion</a>
            </div>
        </div>
    </div>
</div>

<!-- Bouton caché pour le modal d'erreur -->
<button type="button" id="errorModalButton" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#errorModal" style="display:none;"></button>

<!-- Modal d'erreur -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Erreur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="bi bi-exclamation-circle-fill" style="font-size: 4rem; color: red;"></i>
                    <p>{{ error_message }}</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var errorMessage = '{{ error_message|default:"" }}';
        if (errorMessage !== '') {
            var errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            errorModal.show();
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        var showModal = '{{ show_modal|yesno:"true,false" }}';
        if (showModal === 'true') {
            var successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();
        }
    });
</script>
